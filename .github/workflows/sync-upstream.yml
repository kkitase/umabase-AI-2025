# =====================================================
# 学生リポジトリ自動同期ワークフロー
# =====================================================
# 概要:
#   学生のオリジナルリポジトリに新しいコミットがあれば、
#   このフォーク先リポジトリに自動で取り込みます。
#   更新があった場合のみ、Discord に詳細を通知します。
#
# 動作タイミング:
#   - 毎時0分 (1時間に1回)
#   - GitHub Actions 画面から手動実行も可能
# =====================================================

name: Sync Fork

on:
  schedule:
    - cron: "0 * * * *"  # 毎時0分に実行
  workflow_dispatch:      # 手動実行ボタンを有効化

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # リポジトリへの書き込み権限

    steps:
      # ----------------------------------------
      # ステップ1: リポジトリをチェックアウト
      # ----------------------------------------
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # 全履歴を取得

      # ----------------------------------------
      # ステップ2: 同期前の状態を記録
      # ----------------------------------------
      - name: Record Pre-Sync SHA
        id: pre_sync
        run: |
          echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "📍 同期前のコミット: $(git rev-parse --short HEAD)"

      # ----------------------------------------
      # ステップ3: 学生のオリジナルリポジトリから同期
      # ----------------------------------------
      - name: Sync with Upstream (Student Repository)
        id: sync
        uses: aormsby/Fork-Sync-With-Upstream-action@v3.4
        with:
          upstream_sync_repo: tnao727272-gif/umabase-AI-2025  # 学生のリポジトリ
          upstream_sync_branch: main
          target_sync_branch: main
          target_repo_token: ${{ secrets.GITHUB_TOKEN }}
          test_mode: false
          git_pull_rebase_config: true         # リベースを使用してマージ
          upstream_pull_args: --no-edit        # 自動マージメッセージを使用

      # ----------------------------------------
      # ステップ4: 更新があれば Discord に通知
      # ----------------------------------------
      - name: Notify Discord on Changes
        if: success()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          PREV_SHA: ${{ steps.pre_sync.outputs.sha }}
          UPSTREAM_REPO: tnao727272-gif/umabase-AI-2025
        run: |
          # ===== 変数の準備 =====
          # 同期後の最新コミットハッシュを取得
          NEW_SHA=$(git rev-parse HEAD)
          
          echo "📍 同期前: $PREV_SHA"
          echo "📍 同期後: $NEW_SHA"
          
          # ===== 更新有無の判定 =====
          if [ "$PREV_SHA" != "$NEW_SHA" ]; then
            echo "📢 新しいコミットを検知しました。Discord に通知を送信します..."
            
            # ===== コミット情報の抽出 =====
            # マージコミットの場合は2番目の親（upstream側）から情報を取得
            # 通常コミットの場合はHEADから取得
            if git rev-parse HEAD^2 >/dev/null 2>&1; then
              # マージコミットの場合
              AUTHOR=$(git log -1 HEAD^2 --format='%an')
              MESSAGE=$(git log -1 HEAD^2 --format='%s')
            else
              # 通常のコミットの場合
              AUTHOR=$(git log -1 --format='%an')
              MESSAGE=$(git log -1 --format='%s')
            fi
            
            # 変更されたファイル一覧（最大10件）
            FILES=$(git diff --name-only $PREV_SHA $NEW_SHA | head -n 10 | sed 's/^/- /')
            COUNT=$(git diff --name-only $PREV_SHA $NEW_SHA | wc -l)
            
            # 10件を超える場合は「...その他」を追記
            if [ "$COUNT" -gt 10 ]; then
              FILES="$FILES"$'\n- ...その他'
            fi
            
            # 変更サマリ（追加・削除行数）
            SUMMARY=$(git diff --stat $PREV_SHA $NEW_SHA | tail -n 1)
            
            # ===== Discord 通知の送信 =====
            # jq を使って JSON を安全に構築
            payload=$(jq -n \
              --arg title "🚀 【$UPSTREAM_REPO】更新を検知" \
              --arg author "$AUTHOR" \
              --arg msg "$MESSAGE" \
              --arg files "$FILES" \
              --arg summary "$SUMMARY" \
              '{
                embeds: [{
                  title: $title,
                  color: 3447003,
                  fields: [
                    { name: "👤 更新者", value: $author, inline: true },
                    { name: "📝 メッセージ", value: $msg },
                    { name: "📁 変更ファイル", value: ("```\n" + $files + "\n```") },
                    { name: "🔍 変更サマリ", value: $summary }
                  ],
                  footer: { text: "Kobe Workshop Bot" }
                }]
              }')
            
            curl -H "Content-Type: application/json" -X POST -d "$payload" "$DISCORD_WEBHOOK_URL"
            echo "✅ Discord への通知が完了しました。"
          else
            echo "ℹ️ 新しいコミットはありません。通知をスキップします。"
          fi
