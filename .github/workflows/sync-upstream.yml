# =====================================================
# å­¦ç”Ÿãƒªãƒã‚¸ãƒˆãƒªè‡ªå‹•åŒæœŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# =====================================================
# æ¦‚è¦:
#   å­¦ç”Ÿã®ã‚ªãƒªã‚¸ãƒŠãƒ«ãƒªãƒã‚¸ãƒˆãƒªã«æ–°ã—ã„ã‚³ãƒŸãƒƒãƒˆãŒã‚ã‚Œã°ã€
#   ã“ã®ãƒ•ã‚©ãƒ¼ã‚¯å…ˆãƒªãƒã‚¸ãƒˆãƒªã«è‡ªå‹•ã§å–ã‚Šè¾¼ã¿ã¾ã™ã€‚
#   æ›´æ–°ãŒã‚ã£ãŸå ´åˆã®ã¿ã€Discord ã«è©³ç´°ã‚’é€šçŸ¥ã—ã¾ã™ã€‚
#
# å‹•ä½œã‚¿ã‚¤ãƒŸãƒ³ã‚°:
#   - æ¯æ™‚0åˆ† (1æ™‚é–“ã«1å›)
#   - GitHub Actions ç”»é¢ã‹ã‚‰æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
# =====================================================

name: Sync Fork

on:
  schedule:
    - cron: "0 * * * *"  # æ¯æ™‚0åˆ†ã«å®Ÿè¡Œ
  workflow_dispatch:      # æ‰‹å‹•å®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # ãƒªãƒã‚¸ãƒˆãƒªã¸ã®æ›¸ãè¾¼ã¿æ¨©é™

    steps:
      # ----------------------------------------
      # ã‚¹ãƒ†ãƒƒãƒ—1: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      # ----------------------------------------
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—

      # ----------------------------------------
      # ã‚¹ãƒ†ãƒƒãƒ—2: åŒæœŸå‰ã®ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ã‚’è¨˜éŒ²
      # ----------------------------------------
      - name: Record Current Commit Hash (Before Sync)
        id: before_sync
        run: |
          echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "ğŸ“ åŒæœŸå‰ã®ã‚³ãƒŸãƒƒãƒˆ: $(git rev-parse --short HEAD)"

      # ----------------------------------------
      # ã‚¹ãƒ†ãƒƒãƒ—3: å­¦ç”Ÿã®ã‚ªãƒªã‚¸ãƒŠãƒ«ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰åŒæœŸ
      # ----------------------------------------
      - name: Sync with Upstream (Student Repository)
        id: sync
        uses: aormsby/Fork-Sync-With-Upstream-action@v3.4
        with:
          upstream_sync_repo: tnao727272-gif/umabase-AI-2025  # å­¦ç”Ÿã®ãƒªãƒã‚¸ãƒˆãƒª
          upstream_sync_branch: main
          target_sync_branch: main
          target_repo_token: ${{ secrets.GITHUB_TOKEN }}
          test_mode: false

      # ----------------------------------------
      # ã‚¹ãƒ†ãƒƒãƒ—4: æ›´æ–°ãŒã‚ã‚Œã° Discord ã«é€šçŸ¥
      # ----------------------------------------
      - name: Notify Discord on Changes
        if: success()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          PREV_SHA: ${{ steps.before_sync.outputs.sha }}
        run: |
          # ===== åŒæœŸå¾Œã®æœ€æ–°ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ã‚’å–å¾— =====
          NEW_SHA=$(git rev-parse HEAD)
          
          echo "ğŸ“ åŒæœŸå‰: $PREV_SHA"
          echo "ğŸ“ åŒæœŸå¾Œ: $NEW_SHA"
          
          # ===== æ›´æ–°æœ‰ç„¡ã®åˆ¤å®š =====
          if [ "$PREV_SHA" != "$NEW_SHA" ]; then
            echo "ğŸ“¢ æ–°ã—ã„ã‚³ãƒŸãƒƒãƒˆã‚’æ¤œçŸ¥ã—ã¾ã—ãŸã€‚Discord ã«é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã™..."
            
            # ===== ã‚³ãƒŸãƒƒãƒˆæƒ…å ±ã®æŠ½å‡º =====
            AUTHOR=$(git log -1 --format='%an')    # æ›´æ–°è€…å
            MESSAGE=$(git log -1 --format='%s')    # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            
            # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ï¼ˆæœ€å¤§10ä»¶ï¼‰
            FILES=$(git diff --name-only $PREV_SHA $NEW_SHA | head -n 10 | sed 's/^/- /')
            COUNT=$(git diff --name-only $PREV_SHA $NEW_SHA | wc -l)
            
            # 10ä»¶ã‚’è¶…ãˆã‚‹å ´åˆã¯ã€Œ...ãã®ä»–ã€ã‚’è¿½è¨˜
            if [ "$COUNT" -gt 10 ]; then
              FILES="$FILES"$'\n- ...ãã®ä»–'
            fi
            
            # ===== Discord é€šçŸ¥ã®é€ä¿¡ =====
            # jq ã‚’ä½¿ã£ã¦ JSON ã‚’å®‰å…¨ã«æ§‹ç¯‰
            payload=$(jq -n \
              --arg title "ğŸš€ ã€${{ github.repository }}ã€‘æ›´æ–°ã‚’æ¤œçŸ¥" \
              --arg author "$AUTHOR" \
              --arg msg "$MESSAGE" \
              --arg files "$FILES" \
              '{
                embeds: [{
                  title: $title,
                  color: 3447003,
                  fields: [
                    { name: "ğŸ‘¤ æ›´æ–°è€…", value: $author, inline: true },
                    { name: "ğŸ“ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸", value: $msg },
                    { name: "ğŸ“ å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«", value: ("```\n" + $files + "\n```") }
                  ],
                  footer: { text: "Kobe Workshop Bot" }
                }]
              }')
            
            curl -H "Content-Type: application/json" -X POST -d "$payload" "$DISCORD_WEBHOOK_URL"
            echo "âœ… Discord ã¸ã®é€šçŸ¥ãŒå®Œäº†ã—ã¾ã—ãŸã€‚"
          else
            echo "â„¹ï¸ æ–°ã—ã„ã‚³ãƒŸãƒƒãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚é€šçŸ¥ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
          fi
